<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Egresos</title>
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
<header class="row wrap" style="justify-content:space-between">
  <nav>
    <a href="/">Inicio</a>
    <a href="/egresos/nuevo">+ Egreso</a>
    <a href="/ingresos">Ingresos</a>
  </nav>
  <div class="row">
    <a class="badge" href="/api/egresos/export.csv">CSV</a>
    <a class="badge" href="/api/egresos/export.xlsx">XLSX</a>
  </div>
</header>

<main class="wrap">
  <h1>Egresos</h1>
  <div class="row">
    <select id="f_sem">
      <option value="">Semestre (todos)</option>
      <option>126</option><option>226</option><option>326</option>
      <option>426</option><option>526</option><option>626</option>
    </select>
    <select id="f_cta">
      <option value="">Cuenta (todas)</option>
      <option>EFECTIVO</option><option>EFECTY</option>
      <option>BANCOLOMBIA_1423</option><option>NEQUI</option><option>DAVIVIENDA</option>
    </select>
    <select id="f_cat">
      <option value="">Categoría (todas)</option>
      <option>CARROS</option><option>SEGURIDAD_SOCIAL</option><option>ADELANTO</option>
      <option>ITAU-APTOS</option><option>MERCADO</option><option>PAGO_NÓMINA</option>
      <option>VIATICOS</option><option>IMPUESTOS</option><option>PRIMAS</option>
      <option>CESANTIAS</option><option>OTROS</option>
    </select>
    <button id="btn_ref">Actualizar</button>
  </div>

  <table id="tbl">
    <thead><tr>
      <th>Fecha</th><th>Cuenta</th><th>Método</th><th>Cantidad</th><th>Cantidad real</th>
      <th>Semestre</th><th>Categoría</th><th>Razón</th><th>Autorizó</th><th>Responsable</th>
    </tr></thead>
    <tbody></tbody>
  </table>
  <p class="mt muted" id="sum"></p>
</main>

<script src="/static/script.js"></script>
<script>
async function load(){
  const params = new URLSearchParams();
  const sem = document.getElementById('f_sem').value;
  const cta = document.getElementById('f_cta').value;
  const cat = document.getElementById('f_cat').value;
  if(sem) params.set('semestre', sem);
  if(cta) params.set('cuenta', cta);
  if(cat) params.set('categoria', cat);

  const r = await fetch('/api/egresos' + (params.toString()?`?${params}`:""));
  const data = await r.json();
  const tb = document.querySelector('#tbl tbody'); tb.innerHTML = "";
  let total = 0, totalReal = 0;
  data.rows.forEach(x=>{
    total += Number(x.CANTIDAD)||0;
    totalReal += Number(x.CANTIDAD_REAL)||0;
    const tr = el('tr',{}, el('td',{html:x.FECHA}), el('td',{html:x.CUENTA}), el('td',{html:x["MÉTODO"]}),
      el('td',{html:fmtCOP(x.CANTIDAD)}), el('td',{html:fmtCOP(x.CANTIDAD_REAL)}),
      el('td',{html:x.SEMESTRE}), el('td',{html:x.CATEGORIA}), el('td',{html:x["RAZÓN"]}),
      el('td',{html:x["AUTORIZÓ"]}), el('td',{html:x.RESPONSABLE})
    );
    tb.append(tr);
  });
  document.getElementById('sum').textContent = "Totales — Bruto: $ "+fmtCOP(total)+" | Real: $ "+fmtCOP(totalReal);
}
['f_sem','f_cta','f_cat'].forEach(id=>document.getElementById(id).addEventListener('change',load));
document.getElementById('btn_ref').addEventListener('click',load);
load();
</script>
</body>
</html>
