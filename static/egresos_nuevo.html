<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Nuevo egreso</title>
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
<header class="row wrap" style="justify-content:space-between">
  <nav>
    <a href="/">Inicio</a>
    <a href="/egresos">Egresos</a>
    <a href="/ingresos">Ingresos</a>
  </nav>
</header>

<main class="wrap">
  <h1>Nuevo egreso</h1>
  <form id="form-egreso" class="grid">
    <label>Monto (COP)
      <input type="text" id="e_monto" data-money inputmode="numeric" autocomplete="off" required>
    </label>

    <label>Semestre
      <select id="e_semestre" required>
        <option value="" selected disabled hidden>Seleccione…</option>
        <option>126</option><option>226</option><option>326</option>
        <option>426</option><option>526</option><option>626</option>
      </select>
    </label>

    <label>Cuenta
      <select id="e_cuenta" required>
        <option value="" selected disabled hidden>Seleccione…</option>
        <option>EFECTIVO</option>
        <option>EFECTY</option>
        <option>BANCOLOMBIA_1423</option>
        <option>NEQUI</option>
        <option>DAVIVIENDA</option>
      </select>
    </label>

    <label>Método
      <select id="e_metodo" required>
        <option value="" selected disabled hidden>Seleccione…</option>
        <option>EFECTIVO</option>
        <option>BANCOLOMBIA</option>
        <option>PSE</option>
        <option>NEQUI</option>
        <option>TRANSFERENCIA</option>
        <option>TARJETA</option>
      </select>
    </label>

    <label>Categoría
      <select id="e_categoria" required>
        <option value="" selected disabled hidden>Seleccione…</option>
        <option>CARROS</option>
        <option>SEGURIDAD_SOCIAL</option>
        <option>ADELANTO</option>
        <option>ITAU-APTOS</option>
        <option>MERCADO</option>
        <option>PAGO_NÓMINA</option>
        <option>VIATICOS</option>
        <option>IMPUESTOS</option>
        <option>PRIMAS</option>
        <option>CESANTIAS</option>
        <option>OTROS</option>
      </select>
    </label>

    <label id="e_mes_wrap" style="display:none">Mes
      <select id="e_mes">
        <option value="" selected disabled hidden>Seleccione…</option>
        <option>ENERO</option><option>FEBRERO</option><option>MARZO</option>
        <option>ABRIL</option><option>MAYO</option><option>JUNIO</option>
        <option>JULIO</option><option>AGOSTO</option><option>SEPTIEMBRE</option>
        <option>OCTUBRE</option><option>NOVIEMBRE</option><option>DICIEMBRE</option>
      </select>
    </label>

    <label id="e_nombre_carro_wrap" style="display:none">Nombre del carro
      <input type="text" id="e_nombre_carro" placeholder="p. ej. SPARK">
    </label>

    <label id="e_motivo_carro_wrap" style="display:none">Motivo carro
      <select id="e_motivo_carro">
        <option value="" selected disabled hidden>Seleccione…</option>
        <option>GASOLINA</option><option>PARQUEADERO</option><option>MANTENIMIENTO</option>
        <option>LAVADO</option><option>PEAJES</option><option>SEGURO</option><option>OTRO</option>
      </select>
    </label>

    <label>Razón (texto libre)
      <input type="text" id="e_razon" placeholder="Opcional">
    </label>

    <label>Autorizó
      <input type="text" id="e_autorizo" placeholder="Opcional">
    </label>

    <label>Responsable
      <input type="text" id="e_responsable" placeholder="Opcional">
    </label>

    <div class="row">
      <button type="submit" id="btn_egr">Generar egreso</button>
      <a class="muted" href="/egresos" style="align-self:center">Ver tabla</a>
    </div>
  </form>
  <p id="e_msg" class="mt muted"></p>
</main>

<script src="/static/script.js"></script>
<script>
  const CAT_PIDE_MES = new Set([
    "ADELANTO","ITAU-APTOS","MERCADO","PAGO_NÓMINA","VIATICOS","IMPUESTOS","PRIMAS","SEGURIDAD_SOCIAL"
  ]);
  document.getElementById('e_categoria').addEventListener('change', e=>{
    const cat=e.target.value;
    document.getElementById('e_mes_wrap').style.display = CAT_PIDE_MES.has(cat) ? '' : 'none';
    const showCar = (cat==='CARROS');
    document.getElementById('e_nombre_carro_wrap').style.display = showCar ? '' : 'none';
    document.getElementById('e_motivo_carro_wrap').style.display  = showCar ? '' : 'none';
  });

  document.getElementById('form-egreso').addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const btn=document.getElementById('btn_egr'); btn.disabled=true;

    const payload = {
      monto:        normalizeMoney(document.getElementById('e_monto').value),
      semestre:     document.getElementById('e_semestre').value,
      cuenta:       document.getElementById('e_cuenta').value,
      metodo:       document.getElementById('e_metodo').value,
      categoria:    document.getElementById('e_categoria').value,
      mes:          document.getElementById('e_mes').value || "",
      nombre_carro: document.getElementById('e_nombre_carro').value || "",
      motivo_carro: document.getElementById('e_motivo_carro').value || "",
      razon:        document.getElementById('e_razon').value || "",
      autorizo:     document.getElementById('e_autorizo').value || "",
      responsable:  document.getElementById('e_responsable').value || ""
    };

    const r = await fetch('/api/egresos', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });

    if(r.ok){ location.href='/egresos'; }
    else{ document.getElementById('e_msg').textContent='Error: '+await r.text(); btn.disabled=false; }
  });
</script>
</body>
</html>
