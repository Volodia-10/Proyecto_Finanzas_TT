<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Ingresos</title>
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
<header class="row wrap" style="justify-content:space-between">
  <nav>
    <a href="/">Inicio</a>
    <a href="/ingresos/nuevo">+ Ingreso</a>
    <a href="/egresos">Egresos</a>
  </nav>
  <div class="row">
    <a class="badge" href="/api/ingresos/export.csv">CSV</a>
    <a class="badge" href="/api/ingresos/export.xlsx">XLSX</a>
  </div>
</header>

<main class="wrap">
  <h1>Ingresos</h1>
  <div class="row">
    <select id="f_sem" >
      <option value="">Semestre (todos)</option>
      <option>126</option><option>226</option><option>326</option>
      <option>426</option><option>526</option><option>626</option>
    </select>
    <select id="f_banco" >
      <option value="">Banco (todos)</option>
      <option>BANCOLOMBIA_1423</option><option>NEQUI</option><option>DAVIPLATA</option><option>DAVIVIENDA</option>
    </select>
    <select id="f_met" >
      <option value="">Método (todos)</option>
      <option>BANCOLOMBIA</option><option>PSE</option><option>NEQUI</option><option>EFECTIVO</option><option>WOMPI</option><option>PAGO INTERESES</option>
    </select>
    <button id="btn_ref">Actualizar</button>
  </div>

  <table id="tbl">
    <thead><tr>
      <th>Fecha</th><th>Cantidad</th><th>Semestre</th><th>Banco</th><th>Método</th><th>Línea</th><th>User</th><th>Extra</th>
    </tr></thead>
    <tbody></tbody>
  </table>
  <p class="mt muted" id="sum"></p>
</main>

<script src="/static/script.js"></script>
<script>
async function load(){
  const params = new URLSearchParams();
  const sem = document.getElementById('f_sem').value;
  const b   = document.getElementById('f_banco').value;
  const m   = document.getElementById('f_met').value;
  if(sem) params.set('semestre', sem);
  if(b)   params.set('banco', b);
  if(m)   params.set('metodo', m);

  const r = await fetch('/api/ingresos' + (params.toString()?`?${params}`:""));
  const data = await r.json();
  const tb = document.querySelector('#tbl tbody'); tb.innerHTML = "";
  let total = 0;
  data.rows.forEach(x=>{
    total += Number(x.CANTIDAD)||0;
    const tr = el('tr',{}, el('td',{html:x.FECHA}), el('td',{html:fmtCOP(x.CANTIDAD)}),
      el('td',{html:x.SEMESTRE}), el('td',{html:x.BANCO}), el('td',{html:x.METODO}),
      el('td',{html:x["LÍNEA"]}), el('td',{html:x.USER}), el('td',{html:x.EXTRA})
    );
    tb.append(tr);
  });
  document.getElementById('sum').textContent = "Total: $ " + fmtCOP(total);
}
['f_sem','f_banco','f_met'].forEach(id=>document.getElementById(id).addEventListener('change',load));
document.getElementById('btn_ref').addEventListener('click',load);
load();
</script>
</body>
</html>
