{% extends "base.html" %}
{% block title %}Egresos{% endblock %}
{% block content %}
<h1>Egresos</h1>

<div class="row mt">
  <div class="grid">
    <div>
      <label>Semestre</label>
      <select id="fSemestre">
        <option value="" selected disabled hidden>Filtrar…</option>
      </select>
    </div>
    <div>
      <label>Cuenta</label>
      <select id="fCuenta">
        <option value="" selected disabled hidden>Filtrar…</option>
      </select>
    </div>
    <div>
      <label>Categoría</label>
      <select id="fCategoria">
        <option value="" selected disabled hidden>Filtrar…</option>
      </select>
    </div>

    <div class="row">
      <a class="btn" href="/egresos/nuevo">+ Nuevo egreso</a>
      <a class="btn" href="/api/egresos/export.csv">CSV</a>
      <a class="btn" href="/api/egresos/export.xlsx">XLSX</a>
      <button class="btn" id="btnLimpiar">Limpiar filtros</button>
    </div>
  </div>
</div>

<table id="tblEgresos" class="mt">
  <thead>
    <tr>
      <th>Fecha</th>
      <th>Cuenta</th>
      <th>Método</th>
      <th>Monto (COP)</th>
      <th>Real (COP)</th>
      <th>Semestre</th>
      <th>Categoría</th>
      <th>Razón</th>
      <th>Autorizó</th>
      <th>Responsable</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
(function () {
  const $ = (q, d=document)=>d.querySelector(q);
  const nfCOP = new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0});

  const fSem = $('#fSemestre'), fCta = $('#fCuenta'), fCat = $('#fCategoria');
  const tbody = $('#tblEgresos tbody');
  const btnLimpiar = $('#btnLimpiar');

  function params() {
    const p = new URLSearchParams();
    if (fSem.value) p.set('semestre', fSem.value);
    if (fCta.value) p.set('cuenta',   fCta.value);
    if (fCat.value) p.set('categoria',fCat.value);
    return p.toString();
  }

  function fillOptions(rows){
    const sem = new Set(), cta = new Set(), cat = new Set();
    rows.forEach(r => {
      if (r.SEMESTRE)  sem.add(r.SEMESTRE);
      if (r.CUENTA)    cta.add(r.CUENTA);
      if (r.CATEGORIA) cat.add(r.CATEGORIA);
    });
    function setOpts(sel, set){
      sel.innerHTML = '<option value="" selected disabled hidden>Filtrar…</option>';
      [...set].sort().forEach(v=>{
        const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o);
      });
      sel.value="";
    }
    setOpts(fSem, sem); setOpts(fCta, cta); setOpts(fCat, cat);
  }

  async function load(initial=false){
    const url = '/api/egresos' + (initial ? '' : (params() ? `?${params()}` : ''));
    const res = await fetch(url); const data = await res.json();
    const rows = data.rows || [];
    if (initial) fillOptions(rows);
    tbody.innerHTML = rows.map(r=>`
      <tr>
        <td>${r.FECHA}</td>
        <td>${r.CUENTA}</td>
        <td>${r["MÉTODO"]}</td>
        <td style="text-align:right">${nfCOP.format(r.CANTIDAD)}</td>
        <td style="text-align:right">${nfCOP.format(r.CANTIDAD_REAL)}</td>
        <td>${r.SEMESTRE}</td>
        <td>${r.CATEGORIA}</td>
        <td>${r.RAZÓN}</td>
        <td>${r["AUTORIZÓ"] ?? ""}</td>
        <td>${r.RESPONSABLE ?? ""}</td>
      </tr>
    `).join('');
  }

  fSem.addEventListener('change', ()=>load());
  fCta.addEventListener('change', ()=>load());
  fCat.addEventListener('change', ()=>load());
  btnLimpiar.addEventListener('click', ()=>{
    fSem.value=""; fCta.value=""; fCat.value=""; load(true);
  });

  load(true);
})();
</script>
{% endblock %}
