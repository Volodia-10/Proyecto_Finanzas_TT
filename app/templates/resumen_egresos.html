{% extends "base.html" %}
{% block title %}Resumen Egresos{% endblock %}
{% block content %}
<h1>Resumen de Egresos</h1>

<div class="grid mt">
  <div>
    <h2>Por Semestre</h2>
    <table id="tSem">
      <thead><tr><th>Semestre</th><th>Total (COP)</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
  <div>
    <h2>Por Cuenta</h2>
    <table id="tCta">
      <thead><tr><th>Cuenta</th><th>Total (COP)</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
  <div>
    <h2>Por Categoría</h2>
    <table id="tCat">
      <thead><tr><th>Categoría</th><th>Total (COP)</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<h2 class="mt">Total general</h2>
<p id="tGen" class="warn" style="font-size:18px"></p>

<script>
(async function(){
  const nfCOP = new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0});
  const res = await fetch('/api/egresos'); const data = await res.json();
  const rows = data.rows || [];

  const sum = (acc, k, v)=>{ acc[k]=(acc[k]||0)+Number(v||0); return acc; };

  const bySem = rows.reduce((a,r)=>sum(a, r.SEMESTRE||'—',  r.CANTIDAD_REAL ?? r.CANTIDAD), {});
  const byCta = rows.reduce((a,r)=>sum(a, r.CUENTA||'—',    r.CANTIDAD_REAL ?? r.CANTIDAD), {});
  const byCat = rows.reduce((a,r)=>sum(a, r.CATEGORIA||'—', r.CANTIDAD_REAL ?? r.CANTIDAD), {});
  const total = rows.reduce((t,r)=>t+Number(r.CANTIDAD_REAL ?? r.CANTIDAD || 0), 0);

  function fill(id, obj){
    const tbody = document.querySelector(id+' tbody');
    const keys = Object.keys(obj).sort();
    tbody.innerHTML = keys.map(k=>`<tr><td>${k}</td><td style="text-align:right">${nfCOP.format(obj[k])}</td></tr>`).join('');
  }
  fill('#tSem', bySem); fill('#tCta', byCta); fill('#tCat', byCat);

  document.getElementById('tGen').textContent = nfCOP.format(total);
})();
</script>
{% endblock %}
