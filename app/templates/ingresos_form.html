{% extends "base.html" %}
{% block title %}+ Ingreso{% endblock %}
{% block content %}
<h1>Nuevo Ingreso</h1>

<div class="grid">
  <label>
    Monto (COP)
    <input id="ing_monto" type="text" inputmode="numeric" placeholder="$ 0">
  </label>

  <label>
    Semestre
    <select id="ing_semestre"></select>
  </label>

  <label>
    Cuenta
    <select id="ing_cuenta"></select>
  </label>

  <label>
    Detalle de cuenta / Método
    <select id="ing_detalle"></select>
  </label>

  <label>
    Línea
    <input id="ing_linea" type="text" value="PENDIENTE">
  </label>

  <label>
    User
    <input id="ing_user" type="text" value="PENDIENTE">
  </label>
</div>

<div class="row mt">
  <button id="btn_ing_guardar">Guardar</button>
  <a class="btn" href="/ingresos">Ver Ingresos</a>
</div>

<script>
  // poblar selects SIN selección por defecto
  populateSelect("ing_semestre", SEMESTRES, true);
  populateSelect("ing_cuenta",   CUENTAS_INGRESO, true);
  // detalle depende de cuenta
  setPlaceholder("ing_detalle");
  document.getElementById("ing_cuenta").addEventListener("change", (e) => {
    const cuenta = e.target.value || "";
    const opciones = DETALLE_POR_CUENTA[cuenta] || [];
    populateSelect("ing_detalle", opciones, true);
  });

  // máscara COP
  attachMoneyMask("ing_monto");

  // guardar
  document.getElementById("btn_ing_guardar").addEventListener("click", async () => {
    const monto    = getMoneyValue("ing_monto");
    const semestre = getSel("ing_semestre");
    const cuenta   = getSel("ing_cuenta");
    const detalleV = getSel("ing_detalle");
    const linea    = val("ing_linea").trim() || "PENDIENTE";
    const user     = val("ing_user").trim()  || "PENDIENTE";

    if (!monto || !semestre || !cuenta || !detalleV) {
      alert("Completa Monto, Semestre, Cuenta y Detalle."); return;
    }

    // WOMPI: mapear a metodo='WOMPI' + wompi_mp=PSE/TC
    let metodo = detalleV, wompi_mp = "";
    if (detalleV.startsWith("WOMPI ")) {
      metodo = "WOMPI";
      wompi_mp = detalleV.split(" ")[1]; // PSE o TC
    }

    const payload = { monto, semestre, cuenta, detalle: metodo, wompi_mp, linea, user };

    const r = await fetch("/api/ingresos", {
      method:"POST", headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    const data = await r.json();
    if (data.ok) { alert("Ingreso guardado."); window.location.href="/ingresos"; }
    else { alert("Error creando ingreso"); }
  });
</script>
{% endblock %}
