{% extends "base.html" %}
{% block title %}Resumen Ingresos{% endblock %}
{% block content %}
<h1>Resumen de Ingresos</h1>

<div class="grid mt">
  <div>
    <h2>Por Semestre</h2>
    <table id="tSem">
      <thead><tr><th>Semestre</th><th>Total (COP)</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
  <div>
    <h2>Por Banco</h2>
    <table id="tBan">
      <thead><tr><th>Banco</th><th>Total (COP)</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
  <div>
    <h2>Por Método</h2>
    <table id="tMet">
      <thead><tr><th>Método</th><th>Total (COP)</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<h2 class="mt">Total general</h2>
<p id="tGen" class="ok" style="font-size:18px"></p>

<script>
(async function(){
  const nfCOP = new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0});
  const res = await fetch('/api/ingresos'); const data = await res.json();
  const rows = data.rows || [];

  const sum = (acc, k, v)=>{ acc[k]=(acc[k]||0)+Number(v||0); return acc; };

  const bySem = rows.reduce((a,r)=>sum(a, r.SEMESTRE||'—', r.CANTIDAD), {});
  const byBan = rows.reduce((a,r)=>sum(a, r.BANCO||'—',    r.CANTIDAD), {});
  const byMet = rows.reduce((a,r)=>sum(a, r.METODO||'—',   r.CANTIDAD), {});
  const total = rows.reduce((t,r)=>t+Number(r.CANTIDAD||0), 0);

  function fill(id, obj){
    const tbody = document.querySelector(id+' tbody');
    const keys = Object.keys(obj).sort();
    tbody.innerHTML = keys.map(k=>`<tr><td>${k}</td><td style="text-align:right">${nfCOP.format(obj[k])}</td></tr>`).join('');
  }
  fill('#tSem', bySem); fill('#tBan', byBan); fill('#tMet', byMet);

  document.getElementById('tGen').textContent = nfCOP.format(total);
})();
</script>
{% endblock %}
